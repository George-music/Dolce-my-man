<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dolce - Fun Gallery</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #3c5edb;
      --secondary: #ffe36b;
      --accent: #ffefb4;
      --danger: #e53935;
      --bg: #f9fbff;
      --dark-bg: #18192e;
      --dark-card: #23243b;
      --text: #1a2233;
      --text-light: #e3e7fa;
      --shadow: 0 8px 38px #3c5edb13;
      --music: #ffd358;
    }
    html, body { margin:0; padding:0; min-height:100vh; }
    body {
      font-family: 'Inter', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: background .3s cubic-bezier(.77,0,.18,1), color .3s cubic-bezier(.77,0,.18,1);
    }
    body.dark {
      background: var(--dark-bg);
      color: var(--text-light);
    }
    .navbar {
      background: var(--primary);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 18px;
      height:71px;
      box-shadow: 0 2px 16px rgba(60,94,219,0.16);
    }
    .logo {
      font-size:2.1em; font-weight:900; letter-spacing:1.5px; display:flex; align-items:center; gap:10px;
    }
    .logo span {
      background: var(--secondary);
      border-radius: 50%;
      color: var(--primary);
      width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center; font-size: 1.2em;
      box-shadow: 0 1px 7px #fff5;
    }
    .nav-links button {
      background: none; border: none; color: #fff; font-size: 1.04em; margin-left: 12px; cursor: pointer;
      font-weight:600; padding: 7px 16px; border-radius:6px; transition: background .2s, color .2s;
    }
    .nav-links button:hover, .nav-links button.active {
      background: #fff; color: var(--primary);
    }
    .music-btn {
      background: var(--music); color: #b07300; border: none; border-radius: 50%; width:38px; height:38px; font-size:1.3em; margin-left:8px; cursor:pointer; transition: background .2s;
      box-shadow: 0 2px 10px #ffd35855;
      display: inline-flex; align-items: center; justify-content: center;
      outline: 2px solid transparent;
    }
    .music-btn.on { outline: 2px solid var(--primary);}
    .music-btn:hover { background: #fff7c9;}
    .hero {
      max-width: 900px; margin: 42px auto 30px auto; text-align: center; padding: 38px 16px 34px 16px;
      background: linear-gradient(100deg,#f9fbff 65%, #e3ebff 100%);
      border-radius: 18px; box-shadow: var(--shadow);
      display:flex; flex-direction:column; align-items:center;
      position:relative; overflow:hidden;
    }
    .hero h1 {
      font-size: 2.35em; color: var(--primary); font-weight: 800; letter-spacing: 1.2px;
      margin-bottom: 10px; line-height:1.13;
      text-shadow: 0 3px 16px #e3ebff;
      animation: popIn .7s cubic-bezier(.65,-0.02,.54,1.16) 1;
    }
    @keyframes popIn {
      0% {transform:scale(.8) translateY(30px); opacity:0;}
      80%{transform:scale(1.04) translateY(-2px);}
      100% {transform:scale(1) translateY(0); opacity:1;}
    }
    .hero p {
      color: #333; font-size: 1.13em; margin-bottom: 18px; font-weight: 500;
    }
    .hero .cta {
      margin-top: 6px; background: var(--primary); color: #fff; font-weight:700; border:none;
      padding:13px 33px; border-radius:9px; font-size:1.17em; cursor:pointer; box-shadow:0 3px 10px #3c5edb22;
      transition: background .2s, color .2s;
    }
    .hero .cta:hover { background: var(--text); color:var(--secondary);}
    .categories {
      display: flex; gap:12px; align-items:center; justify-content:center;
      margin:24px auto 0 auto; flex-wrap:wrap; max-width:800px;
    }
    .cat-btn {
      background: #fff; border:1.6px solid var(--primary); color: var(--primary); border-radius:21px;
      font-size: 1.01em; font-weight:700; padding:6px 22px; cursor:pointer;
      transition: background .14s, color .17s, border .17s;
      box-shadow: 0 1px 7px #3c5edb14;
    }
    .cat-btn.active, .cat-btn:hover { background: var(--primary); color: #fff;}
    .trending-bar {
      display: flex; gap:10px; align-items:center;
      background: var(--secondary); color: #b07300; font-weight:700;
      padding:10px 18px; border-radius:13px; max-width:750px; margin:24px auto 0 auto; font-size:1.04em;
      box-shadow: 0 1px 8px #ffe36b55;
    }
    .trending-bar span { margin-right:10px; }
    .trending-bar a { color:#c08c00; text-decoration:underline;}
    .gallery {
      display:grid; grid-template-columns:repeat(auto-fit,minmax(310px,1fr)); gap:32px;
      max-width:1200px; margin:34px auto 38px auto; padding:0 12px;
    }
    .card-anim { transition: box-shadow .22s, transform .21s cubic-bezier(.77,0,.18,1);}
    .post-card {
      background: #fff; border-radius:21px; box-shadow: var(--shadow);
      overflow:hidden; display:flex; flex-direction:column; position:relative;
      cursor:pointer; will-change: transform;
      transition: box-shadow .23s cubic-bezier(.77,0,.18,1), transform .23s cubic-bezier(.77,0,.18,1);
    }
    .post-card:hover { box-shadow:0 16px 48px #3c5edb33; transform:scale(1.028) rotateZ(-1.4deg);}
    .post-card:active { transform:scale(.98);}
    .post-card.dark { background: var(--dark-card);}
    .post-media {
      width:100%; background: #efeffb; display: flex; align-items:center; justify-content:center; min-height: 210px;
      position:relative;
      overflow:hidden;
    }
    .post-media img, .post-media video {
      max-width:100%; max-height:320px; border-radius:12px; margin: 0 auto; display:block; box-shadow:0 2px 9px #3c5edb12;
      transition:transform .19s cubic-bezier(.77,0,.18,1);
    }
    .post-card:hover .post-media img, .post-card:hover .post-media video { transform:scale(1.045);}
    .post-media video { background:#222; }
    .post-content { padding: 21px 18px 17px 18px; position:relative;}
    .post-title { font-weight:800; font-size:1.18em; color:var(--primary); }
    .post-desc { font-size:1.04em; color:#333; margin-top:7px; }
    .post-actions { display:flex; gap:14px; margin:17px 0 0 0; flex-wrap:wrap; }
    .reaction-btn {
      background:#fff; border:1.7px solid #eee; border-radius:50%; font-size:1.38em; padding:6px 8px; cursor:pointer;
      transition:.13s; box-shadow:0 1px 7px #3c5edb12;
      position:relative; min-width:44px; min-height:44px;
      display:inline-flex; align-items:center; justify-content:center;
    }
    .reaction-btn.active, .reaction-btn.liked { border:2.4px solid var(--primary); background:var(--accent);}
    .reaction-count { font-size:.97em; color:var(--primary); margin-left:5px; font-weight:700;}
    .action-btn {
      background:#f6f6fa; border:none; border-radius:6px; font-size:1.13em; padding:7px 15px; cursor:pointer; transition:.1s;
      font-weight:600;
    }
    .action-btn:hover { background:var(--secondary); color:var(--primary);}
    .admin-panel {
      display:none; max-width:430px; margin:38px auto 0 auto; background:#fff; padding:28px 24px 25px 24px;
      border-radius:12px; box-shadow:0 3px 17px #3c5edb0d;
    }
    .admin-panel.active { display:block; }
    #postForm { display:flex; flex-direction:column; gap:13px; }
    #postForm input, #postForm textarea {
      font-size:1.08em; padding:11px 14px; border-radius:7px; border:1px solid #d1d9f4; background:#fafbff; resize:none;
    }
    #postForm button {
      background:var(--primary); color:#fff; font-weight:800; border:none; padding:13px 0; border-radius:7px; cursor:pointer;
      font-size:1.1em; letter-spacing:1px;
    }
    #logoutBtn {
      margin-top:13px; background:var(--danger); color:#fff; border:none; border-radius:7px; padding:11px 0; font-weight:700; cursor:pointer;
      font-size:1em;
    }
    #formMsg { color:var(--danger); margin-top:9px; min-height:23px; }
    .ad-slot { text-align:center; margin:20px auto; min-height:54px; color:#888; font-size:.99em; max-width:728px; }
    .random-btn {
      display:block; margin:30px auto 36px auto; background:var(--secondary); color:#b07300; font-weight:800; border:none;
      border-radius:11px; padding:16px 38px; font-size:1.13em; cursor:pointer; box-shadow:0 1px 7px #ffe36b44; transition: background .18s;
    }
    .random-btn:hover { background:#fff7c9;}
    .load-more-bar {display:flex; justify-content:center; margin:30px 0;}
    #loadMoreBtn {
      background:var(--primary); color:#fff; border:none; border-radius:9px; font-size:1.09em; font-weight:800;
      padding:13px 36px; cursor:pointer; letter-spacing:.5px;
    }
    #loadMoreBtn:hover { background: var(--text);}
    /* Modal styles */
    .modal-backdrop {
      position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(26,34,51,0.18); z-index:999;
      display:flex; align-items:center; justify-content:center;
      animation: fadeIn .33s;
    }
    @keyframes fadeIn {from{opacity:0;}to{opacity:1;}}
    .modal {
      background:#fff; border-radius:19px; max-width:95vw; max-height:93vh; overflow-y:auto;
      box-shadow:0 16px 60px 0 rgba(49,103,230,0.22); padding:39px 39px 31px 39px; position:relative;
      min-width:320px; animation: popIn .6s cubic-bezier(.65,-0.02,.54,1.16) 1;
    }
    .modal .about-emoji {
      font-size:3.2em; filter: drop-shadow(0 3px 16px var(--accent));
      animation: bounce 1.5s infinite alternate cubic-bezier(.77,0,.18,1);
      margin-bottom:10px;
    }
    @keyframes bounce { 
      from{transform:translateY(0);}
      to{transform:translateY(-14px) scale(1.11);}
    }
    .modal .about-story {
      font-size:1.13em; margin-bottom:18px; font-weight:500; color:var(--primary);
    }
    .loading-overlay {
      position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(245,246,250,0.88); z-index:9999;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      font-size:2.5em;
      color:var(--primary);
      transition: opacity .23s;
      pointer-events: none;
      user-select:none;
    }
    .loading-emoji {
      animation: spin 1.2s linear infinite;
      font-size:2.5em;
      margin-bottom:8px;
    }
    @keyframes spin {100%{transform: rotate(360deg);}}
    .loading-msg {font-size:1.14em; color:var(--primary);}
    /* Dark mode overrides */
    body.dark .post-card { background: var(--dark-card); color:var(--text-light);}
    body.dark .post-title { color:var(--secondary);}
    body.dark .gallery { background: var(--dark-bg);}
    body.dark .hero h1 { color: var(--secondary);}
    body.dark .navbar { background: var(--dark-card);}
    body.dark .nav-links button { color:var(--secondary);}
    body.dark .post-desc { color: var(--text-light);}
    body.dark .admin-panel {background: var(--dark-card); color:var(--text-light);}
    body.dark .modal {background: var(--dark-card);}
    body.dark .modal h2, body.dark .modal h3 {color: var(--secondary);}
    .music-btn {transition:background .2s, outline .2s;}
    @media (max-width:900px) {
      .gallery {grid-template-columns:1fr;}
      .hero {padding:20px 5vw;}
      .admin-panel {width:98vw;}
      .modal {padding:20px 5vw 18px 5vw;}
    }
    @media (max-width:600px) {
      .main { padding:0 2px;}
      .gallery {grid-template-columns:1fr;}
      .post-content {padding:13px 7px 10px 7px;}
      .hero { padding:12px 2vw;}
      .hero h1 { font-size:1.3em;}
      .modal {padding:12px 2vw 10px 2vw; min-width:unset;}
      .modal h2 { font-size:1.18em;}
      .admin-panel {width:99vw; padding:13px 2vw;}
      .random-btn {padding:12px 10vw;}
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <span class="logo"><span>😎</span> Dolce</span>
    <span class="nav-links">
      <button onclick="scrollToGallery()">Gallery</button>
      <button onclick="showTrending()">Trending</button>
      <button onclick="showRandom()">Random</button>
      <button id="darkModeBtn" onclick="toggleDarkMode()" title="Toggle dark mode">🌙</button>
      <button onclick="showAbout()">About</button>
      <button class="music-btn" id="musicBtn" title="Toggle music">🎵</button>
      <button id="adminBtn" onclick="showAdminPanel()">Admin</button>
    </span>
  </nav>
  <div class="ad-slot ad-top">[Ad banner here]</div>
  <main>
    <section class="hero">
      <h1>Welcome to Dolce!</h1>
      <p>The funniest images & videos from WhatsApp statuses, now online.<br>
        Laugh, react, and enjoy endless fun with Dolce and friends!</p>
      <button class="cta" onclick="scrollToGallery()">See Gallery</button>
    </section>
    <div class="categories" id="categories"></div>
    <section id="trendingBar" class="trending-bar"></section>
    <div id="loadingOverlay" class="loading-overlay" style="display:none;">
      <span class="loading-emoji" id="loadingEmoji">🎵</span>
      <div class="loading-msg" id="loadingMsg">Loading the funniest stuff...</div>
    </div>
    <section id="gallery" class="gallery"></section>
    <div class="ad-slot ad-infeed">[Ad here]</div>
    <div id="loadMoreWrapper" class="load-more-bar">
      <button id="loadMoreBtn" onclick="loadMorePosts()">Load More</button>
    </div>
    <button class="random-btn" onclick="showRandomPost()">Show Me Something Funny!</button>
    <div class="ad-slot ad-footer">[Ad footer]</div>
    <section id="adminPanel" class="admin-panel">
      <h2>Admin Panel</h2>
      <form id="postForm" enctype="multipart/form-data">
        <input type="text" id="postTitle" placeholder="Title" required>
        <textarea id="postDesc" placeholder="Description (optional)"></textarea>
        <select id="postCategory" required>
          <option value="">Pick a category</option>
          <option value="Fails">Fails</option>
          <option value="Dance">Dance</option>
          <option value="Pets">Pets</option>
          <option value="Family">Family</option>
          <option value="Random">Random</option>
        </select>
        <input type="file" id="postMedia" accept="image/*,video/*" multiple required>
        <button type="submit">Post</button>
        <div id="formMsg"></div>
      </form>
      <button onclick="logout()" id="logoutBtn">Logout</button>
    </section>
  </main>
  <div id="modal-root"></div>
  <audio id="bgMusic" loop preload="auto">
    <source src="https://cdn.pixabay.com/audio/2022/10/16/audio_12b2f6a1b3.mp3" type="audio/mp3">
  </audio>
  <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>
  <script>
    // --- Appwrite Config ---
    const APPWRITE_ENDPOINT = "https://fra.cloud.appwrite.io/v1";
    const APPWRITE_PROJECT = "684f099b000e8e402349";
    const APPWRITE_DB_ID = "684f0a0f001a46d72f20";
    const APPWRITE_COLLECTION_ID = "684f0a22002bef8ed873";
    const BUCKET_ID = "684f0d8b002f36d77e67";
    const ADMIN_EMAIL = "supremealpha04@gmail.com";
    const POSTS_PER_PAGE = 9;
    const CATEGORIES = ["Fails", "Dance", "Pets", "Family", "Random"];

    const client = new Appwrite.Client();
    client.setEndpoint(APPWRITE_ENDPOINT).setProject(APPWRITE_PROJECT);
    const account = new Appwrite.Account(client);
    const db = new Appwrite.Databases(client);
    const storage = new Appwrite.Storage(client);

    let posts = [];
    let likes = {};
    let currentPage = 0;
    let isAdmin = false;
    let trendingPosts = [];
    let currentCategory = "All";
    let musicOn = false;

    // --- Loading Spinner ---
    function showLoading(msg = "Loading the funniest stuff...") {
      document.getElementById("loadingMsg").innerText = msg;
      document.getElementById("loadingOverlay").style.display = "";
      document.getElementById("loadingEmoji").innerText = ["🎵","😂","😎","🔥","🎶","😄"][Math.floor(Math.random()*6)];
    }
    function hideLoading() {
      document.getElementById("loadingOverlay").style.display = "none";
    }

    // --- Categories/Filters ---
    function renderCategories() {
      const cats = ["All", ...CATEGORIES];
      document.getElementById("categories").innerHTML = cats.map(cat =>
        `<button class="cat-btn${cat===currentCategory?' active':''}" onclick="selectCategory('${cat}')">${cat}</button>`
      ).join("");
    }
    window.selectCategory = function(cat) {
      currentCategory = cat;
      renderCategories();
      renderGallery();
    }

    // --- Gallery & Trending ---
    async function loadPosts({append=false}={}) {
      showLoading();
      try {
        const res = await db.listDocuments(
          APPWRITE_DB_ID,
          APPWRITE_COLLECTION_ID,
          [
            Appwrite.Query.orderDesc("createdAt"),
            Appwrite.Query.limit(POSTS_PER_PAGE),
            Appwrite.Query.offset(currentPage * POSTS_PER_PAGE)
          ]
        );
        if (append) posts = posts.concat(res.documents);
        else posts = res.documents;
        renderGallery();
        renderTrendingBar();
        if (res.documents.length < POSTS_PER_PAGE) {
          document.getElementById("loadMoreWrapper").style.display = "none";
        } else {
          document.getElementById("loadMoreWrapper").style.display = "";
        }
        hideLoading();
      } catch (e) {
        document.getElementById("gallery").innerHTML = "<div style='color:#e53935;font-weight:700;'>Failed to load content.</div>";
        hideLoading();
      }
    }

    function renderGallery() {
      const gallery = document.getElementById("gallery");
      let filtered = posts;
      if(currentCategory && currentCategory !== "All") {
        filtered = posts.filter(p => (p.category||"Random") === currentCategory);
      }
      gallery.innerHTML = "";
      filtered.forEach(post => {
        let mediaHtml = "";
        if (post.type === "image" && post.media && post.media[0]) {
          mediaHtml = `<img src="${post.media[0]}" alt="${post.title}">`;
        } else if (post.type === "video" && post.media && post.media[0]) {
          mediaHtml = `<video src="${post.media[0]}" controls></video>`;
        }
        const reactions = post.reactions || {laugh:0,surprise:0,heart:0};
        const isLiked = likes[post.$id];
        const card = document.createElement("div");
        card.className = "post-card card-anim" + (document.body.classList.contains("dark") ? " dark" : "");
        card.innerHTML = `
          <div class="post-media">${mediaHtml}</div>
          <div class="post-content">
            <div class="post-title">${post.title}</div>
            ${post.description ? `<div class="post-desc">${post.description}</div>` : ""}
            <div class="post-actions">
              <button class="reaction-btn${isLiked==='laugh'?" liked":""}" onclick="reactToPost('${post.$id}','laugh')">😂<span class="reaction-count">${reactions.laugh||0}</span></button>
              <button class="reaction-btn${isLiked==='surprise'?" liked":""}" onclick="reactToPost('${post.$id}','surprise')">😮<span class="reaction-count">${reactions.surprise||0}</span></button>
              <button class="reaction-btn${isLiked==='heart'?" liked":""}" onclick="reactToPost('${post.$id}','heart')">❤️<span class="reaction-count">${reactions.heart||0}</span></button>
              <button class="action-btn" onclick="sharePost('${post.$id}')">📤 Share</button>
              <button class="action-btn" onclick="downloadMedia('${post.media[0]}','${post.title}')">⬇️</button>
            </div>
            <div style="margin-top:8px;font-size:.99em;color:#3c5edb;">${post.category||"Random"}</div>
          </div>
        `;
        gallery.appendChild(card);
      });
    }

    function renderTrendingBar() {
      trendingPosts = [...posts].sort((a, b) => {
        const ra = a.reactions ? (a.reactions.laugh||0)+(a.reactions.surprise||0)+(a.reactions.heart||0) : 0;
        const rb = b.reactions ? (b.reactions.laugh||0)+(b.reactions.surprise||0)+(b.reactions.heart||0) : 0;
        return rb - ra;
      }).slice(0, 3);
      const bar = document.getElementById("trendingBar");
      if (!trendingPosts.length) { bar.innerHTML = ""; return; }
      bar.innerHTML = `<span>🔥 Trending:</span>` +
        trendingPosts.map(
          post => `<a href="#post-${post.$id}" onclick="highlightPost('${post.$id}')">${post.title}</a>`
        ).join(" ");
    }

    window.highlightPost = function(postId) {
      const gallery = document.getElementById("gallery");
      const cards = Array.from(gallery.querySelectorAll(".post-card"));
      const idx = posts.findIndex(post => post.$id === postId);
      if (idx !== -1 && cards[idx]) {
        cards[idx].scrollIntoView({behavior: "smooth", block: "center"});
        cards[idx].style.boxShadow = "0 0 0 7px var(--secondary)";
        setTimeout(()=>cards[idx].style.boxShadow="", 1400);
      }
    }

    // --- Infinite Scroll / Load More ---
    window.loadMorePosts = function() {
      currentPage++;
      loadPosts({append:true});
    };

    // --- Random Post Feature ---
    window.showRandomPost = function() {
      const filtered = currentCategory && currentCategory !== "All"
        ? posts.filter(p => (p.category||"Random") === currentCategory)
        : posts;
      if (!filtered.length) return;
      const idx = Math.floor(Math.random()*filtered.length);
      highlightPost(filtered[idx].$id);
    };
    function showRandom() { showRandomPost(); }

    // --- Reactions ---
    window.reactToPost = async function(postId, type) {
      if (likes[postId]) return;
      const post = posts.find(p=>p.$id===postId);
      if (!post) return;
      post.reactions = post.reactions || {laugh:0,surprise:0,heart:0};
      post.reactions[type] = (post.reactions[type]||0)+1;
      likes[postId] = type;
      localStorage.setItem("dolceLikes", JSON.stringify(likes));
      renderGallery();
      try {
        await db.updateDocument(
          APPWRITE_DB_ID,
          APPWRITE_COLLECTION_ID,
          postId,
          { reactions: post.reactions }
        );
      } catch {}
    };
    try { likes = JSON.parse(localStorage.getItem("dolceLikes")||"{}"); } catch{}

    // --- Social Sharing ---
    window.sharePost = function(postId) {
      const post = posts.find(p=>p.$id===postId);
      if (!post) return;
      const url = window.location.origin + "/#post-" + postId;
      const text = `😂 Dolce: ${post.title}\n${post.description||""}\n${url}`;
      if (navigator.share) {
        navigator.share({title: post.title, text, url}).catch(()=>{});
      } else {
        const shareLinks = `
          <div style="padding:18px;">
            <h3>Share Post</h3>
            <a href="https://wa.me/?text=${encodeURIComponent(text)}" target="_blank">WhatsApp</a><br>
            <a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}" target="_blank">Facebook</a><br>
            <a href="https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}" target="_blank">Twitter/X</a><br>
            <button onclick="copyToClipboard('${url}')">Copy Link</button>
            <button onclick="closeModal()">Close</button>
          </div>
        `;
        document.getElementById("modal-root").innerHTML = `<div class="modal-backdrop" onclick="closeModal(event)"><div class="modal" onclick="event.stopPropagation()" style="background:#fff;border-radius:11px;max-width:340px;margin:40px auto;">${shareLinks}</div></div>`;
        document.body.style.overflow = "hidden";
      }
    };
    window.copyToClipboard = function(text) {
      navigator.clipboard.writeText(text);
      alert("Link copied!");
      closeModal();
    };

    // --- Download Media ---
    window.downloadMedia = function(url, title) {
      const a = document.createElement("a");
      a.href = url;
      a.download = title.replace(/\s/g,"_");
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>a.remove(),500);
    };

    // --- Dark Mode ---
    window.toggleDarkMode = function() {
      document.body.classList.toggle("dark");
      renderGallery();
      localStorage.setItem("dolceDark", document.body.classList.contains("dark") ? "1" : "");
      document.getElementById('darkModeBtn').innerText = document.body.classList.contains('dark') ? '☀️' : '🌙';
    };
    if(localStorage.getItem("dolceDark")==="1") {
      document.body.classList.add("dark");
      document.getElementById('darkModeBtn').innerText = '☀️';
    }

    // --- Trending Button ---
    function showTrending() {
      document.getElementById("trendingBar").scrollIntoView({behavior:"smooth"});
    }

    // --- Scroll ---
    function scrollToGallery() {
      document.getElementById("gallery").scrollIntoView({behavior:"smooth"});
    }

    // --- Music Toggle ---
    const musicBtn = document.getElementById("musicBtn");
    const bgMusic = document.getElementById("bgMusic");
    musicBtn.onclick = function() {
      if(musicOn) {
        bgMusic.pause();
        musicOn = false;
        musicBtn.classList.remove('on');
      } else {
        bgMusic.play().then(()=>{musicOn=true; musicBtn.classList.add('on');})
        .catch(()=>{alert("Please interact with page to enable music.");});
      }
    };
    bgMusic.onended = ()=>{musicOn=false; musicBtn.classList.remove('on');};
    bgMusic.onpause = ()=>{musicOn=false; musicBtn.classList.remove('on');};
    bgMusic.onplay = ()=>{musicOn=true; musicBtn.classList.add('on');};

    // --- About Modal Glow-Up ---
    function showAbout() {
      document.getElementById("modal-root").innerHTML = `
        <div class="modal-backdrop" onclick="closeModal(event)">
          <div class="modal" onclick="event.stopPropagation()">
            <div class="about-emoji">😎</div>
            <h2 style="color:var(--primary);margin-bottom:14px;">Meet Dolce</h2>
            <div class="about-story">Once upon a status, Dolce started posting memes that made the internet ROFL. Now, Dolce’s gallery brings you the very best of WhatsApp hilarity—curated for fun, filtered with love, and sprinkled with good vibes. <b>Laugh, react, and share the joy!</b></div>
            <div style="font-size:1.04em; margin-bottom:18px;">P.S. Don’t forget to try dark mode and the music button for a true Dolce experience 🎶</div>
            <button style="background:var(--primary);color:#fff;padding:13px 26px;border:none;border-radius:10px;font-weight:800;" onclick="closeModal(event)">Close</button>
          </div>
        </div>
      `;
      document.body.style.overflow = "hidden";
    }
    function closeModal(e) {
      document.getElementById("modal-root").innerHTML = "";
      document.body.style.overflow = "";
    }

    // --- Admin Auth & Panel (unchanged) ---
    function showAdminPanel() {
      if (isAdmin) {
        document.getElementById("adminPanel").classList.add("active");
      } else {
        showLogin();
      }
    }
    function showLogin() {
      document.getElementById("modal-root").innerHTML = `
        <div class="modal-backdrop" onclick="closeModal(event)">
          <div class="modal" onclick="event.stopPropagation()" style="background:#fff; border-radius:14px; max-width:340px; margin:40px auto; padding:28px;">
            <h2 style="color:var(--primary);margin-bottom:8px;">Admin Login</h2>
            <form id="loginForm">
              <input type="email" id="loginEmail" placeholder="Email" required style="width:100%;padding:10px;margin-bottom:13px;">
              <input type="password" id="loginPassword" placeholder="Password" required style="width:100%;padding:10px;">
              <button style="margin-top:15px;width:100%;background:var(--primary);color:#fff;padding:11px 0;border:none;border-radius:7px;font-weight:800;">Login</button>
              <div id="loginMsg" style="color:var(--danger);margin-top:13px;"></div>
            </form>
          </div>
        </div>
      `;
      document.body.style.overflow = "hidden";
      document.getElementById("loginForm").onsubmit = async function(e) {
        e.preventDefault();
        const email = document.getElementById("loginEmail").value.trim();
        const password = document.getElementById("loginPassword").value;
        if (email !== ADMIN_EMAIL) {
          document.getElementById("loginMsg").innerText = "Not authorized.";
          return;
        }
        try {
          await account.createEmailSession(email, password);
          isAdmin = true;
          closeModal();
          document.getElementById("adminPanel").classList.add("active");
        } catch (err) {
          document.getElementById("loginMsg").innerText = "Login failed.";
        }
      };
    }

    async function logout() {
      try { await account.deleteSession("current"); } catch {}
      isAdmin = false;
      document.getElementById("adminPanel").classList.remove("active");
    }

    // --- Admin Post Upload ---
    document.getElementById("postForm").onsubmit = async function(e) {
      e.preventDefault();
      const title = document.getElementById("postTitle").value.trim();
      const description = document.getElementById("postDesc").value.trim();
      const files = document.getElementById("postMedia").files;
      const category = document.getElementById("postCategory").value || "Random";
      if (!title || files.length === 0 || !category) {
        document.getElementById("formMsg").innerText = "Title, category, and media are required.";
        return;
      }
      document.getElementById("formMsg").innerText = "Uploading...";
      try {
        let urls = [];
        let type = "image";
        for (let file of files) {
          const uploadRes = await storage.createFile(BUCKET_ID, Appwrite.ID.unique(), file);
          const fileId = uploadRes.$id;
          const url = `${APPWRITE_ENDPOINT}/storage/buckets/${BUCKET_ID}/files/${fileId}/view?project=${APPWRITE_PROJECT}`;
          urls.push(url);
          if (file.type.startsWith("video")) type = "video";
        }
        await db.createDocument(APPWRITE_DB_ID, APPWRITE_COLLECTION_ID, Appwrite.ID.unique(), {
          title,
          description,
          media: urls,
          type,
          category,
          reactions: {laugh:0,surprise:0,heart:0},
          createdAt: new Date().toISOString()
        });
        document.getElementById("formMsg").innerText = "Posted!";
        currentPage = 0;
        await loadPosts();
        this.reset();
      } catch (err) {
        document.getElementById("formMsg").innerText = "Failed to post.";
        console.error(err);
      }
    };

    // --- Init ---
    (async function(){
      renderCategories();
      try {
        const session = await account.get();
        if (session && session.email === ADMIN_EMAIL) {
          isAdmin = true;
          document.getElementById("adminPanel").classList.add("active");
        }
      } catch {}
      currentPage = 0;
      loadPosts();
    })();
  </script>
</body>
</html>
